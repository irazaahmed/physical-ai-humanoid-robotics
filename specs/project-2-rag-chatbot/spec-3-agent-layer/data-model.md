# Data Model: Project 2 – RAG Chatbot Agent Layer

## Entity: UserQuery
**Definition**: Natural language request from user requiring information retrieval and synthesis

**Fields**:
- `id` (string): Unique identifier for the query request
- `text` (string): The actual query text from the user (3-10000 characters)
- `timestamp` (datetime): When the query was received
- `session_id` (string, optional): Identifier for conversation context
- `metadata` (object, optional): Additional query context and parameters

**Relationships**: 
- One-to-One with QueryEmbedding
- Zero-to-Many with AgentResponse

## Entity: AgentResponse
**Definition**: Synthesized answer generated by the agent based on retrieved content

**Fields**:
- `id` (string): Unique identifier for the response
- `query_id` (string): Reference to the original user query
- `content` (string): The synthesized response content
- `confidence_score` (float): Confidence level in the response accuracy (0.0-1.0)
- `sources` (list): Citations to source materials used in synthesis
- `timestamp` (datetime): When the response was generated
- `processing_time_ms` (float): Time taken to generate the response

**Relationships**:
- Many-to-One with UserQuery (many responses per one query in multi-turn scenarios)
- Many-to-Many with RetrievedChunk (through citations)

## Entity: RetrievalToolCall
**Definition**: Invocation of the retrieval pipeline to obtain relevant content

**Fields**:
- `id` (string): Unique identifier for the tool call
- `agent_request_id` (string): Reference to the agent request making the call
- `parameters` (object): Parameters passed to the retrieval tool (query, k, threshold, filters)
- `timestamp` (datetime): When the tool call was made
- `execution_time_ms` (float): Time taken to execute the tool call
- `status` (enum): Status of the tool call (success, partial, failed)

**Relationships**:
- Many-to-One with AgentRequest
- One-to-Many with RetrievalResult

## Entity: RetrievedChunk
**Definition**: Content chunk from textbook returned by the retrieval pipeline (defined in Spec-2)

**Fields**:
- `id` (string): Unique identifier for this retrieved chunk
- `content` (string): The actual text content of the chunk
- `similarity_score` (float): Semantic similarity score between query and chunk
- `rank` (integer): Position in the ranked results (0-indexed)
- `metadata` (object): Associated metadata:
  - `url` (string): Source URL of the content
  - `module` (string): Module identifier containing the chunk
  - `chapter` (string): Chapter identifier containing the chunk
  - `section` (string): Section title of the content
  - `chunk_index` (integer): The index of this chunk within the original content
  - `hash` (string): Content hash for duplication detection

**Relationships**:
- Many-to-One with RetrievalResult
- Many-to-Many with AgentResponse (through citations)

## Entity: RetrievalResult
**Definition**: Collection of retrieved chunks and metadata returned by the retrieval pipeline

**Fields**:
- `id` (string): Unique identifier for this retrieval result
- `tool_call_id` (string): Reference to the tool call that generated this result
- `chunks` (list): RetrievedChunk objects with similarity scores
- `search_parameters` (object): Parameters used for the search (k, threshold, distance metric)
- `total_chunks_found` (integer): Total number of chunks found before filtering
- `execution_time_ms` (float): Time taken to execute the retrieval
- `retrieval_timestamp` (datetime): When the retrieval was performed

**Relationships**:
- One-to-One with RetrievalToolCall
- One-to-Many with RetrievedChunk

## Entity: AgentSession
**Definition**: Conversation context for multi-turn interactions (future enhancement)

**Fields**:
- `id` (string): Unique identifier for the session
- `user_id` (string): Identifier for the user (if available)
- `started_at` (datetime): When the session started
- `ended_at` (datetime): When the session ended (null if active)
- `messages` (list): List of UserQuery and AgentResponse pairs in the session
- `context_summary` (string): Summarized context for continuation

**Relationships**:
- One-to-Many with UserQuery
- One-to-Many with AgentResponse

## Entity: QueryMetadata
**Definition**: Information about the query including source, timestamp, and confidence requirements

**Fields**:
- `id` (string): Unique identifier for the metadata
- `query_id` (string): Reference to the associated query
- `source_ip` (string): IP address of the request origin
- `user_agent` (string): Information about the client making the request
- `confidence_requirement` (float): Minimum confidence required for results
- `requested_at` (datetime): When the query was made
- `rate_limit_info` (object): Information about rate limiting for this query

**Relationships**:
- One-to-One with UserQuery

## Entity: ResponseMetadata
**Definition**: Information about the response including sources and confidence indicators

**Fields**:
- `id` (string): Unique identifier for the response metadata
- `response_id` (string): Reference to the associated response
- `sources_used_count` (integer): Number of sources used in generating the response
- `average_similarity_score` (float): Average similarity score of sources used
- `confidence_indicator` (float): Overall confidence in the response (0.0-1.0)
- `generation_method` (string): Method used to generate the response
- `generated_at` (datetime): When the response was generated

**Relationships**:
- One-to-One with AgentResponse

## Validation Rules
- UserQuery.text must be between 3 and 10,000 characters
- AgentResponse.confidence_score must be between 0.0 and 1.0
- RetrievedChunk.similarity_score must be between 0.0 and 1.0
- RetrievalToolCall.parameters must include appropriate query text
- All entities must have valid timestamps
- RetrievedChunk metadata must contain all required fields (url, module, chapter, section, chunk_index)

## State Transitions
- UserQuery: RECEIVED → PROCESSING → COMPLETED/FAILED
- RetrievalToolCall: INITIATED → EXECUTING → SUCCESS/FAILED
- AgentResponse: GENERATING → VALIDATING → COMPLETED/FAILED